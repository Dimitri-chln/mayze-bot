"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ping = exports.pingUri = void 0;
const bigint_buffer_1 = require("bigint-buffer");
const dns_1 = require("dns");
const net_1 = require("net");
const url = __importStar(require("url"));
const varint_1 = require("varint");
const PacketDecoder_1 = require("./PacketDecoder");
const PROTOCOL_VERSION = 335; // Minecraft 1.12
/**
 * ping with URI
 * @param {string} uri minecraft://server[:port]
 * @return {Promise<IMinecraftData>}
 */
function pingUri(uri) {
    const { protocol, hostname, port } = url.parse(uri);
    if (!hostname || !protocol || protocol !== 'minecraft:') {
        throw new TypeError('not correct minecraft URI');
    }
    return ping(hostname, port ? parseInt(port, 10) : undefined);
}
exports.pingUri = pingUri;
/**
 * ping with hostname and port
 * @param {string=} hostname hostname
 * @param {number=} port port number (defaults 25565)
 * @returns {Promise<IMinecraftData>}
 */
async function ping(hostname = 'localhost', port = 25565) {
    let address = { hostname, port };
    try {
        address = await checkSrvRecord(address.hostname);
    }
    catch (err) {
        // ignore
    }
    return openConnection(address);
}
exports.ping = ping;
function checkSrvRecord(hostname) {
    return new Promise((resolve, reject) => {
        if (net_1.isIP(hostname) !== 0) {
            reject(new Error('Hostname is an IP address'));
        }
        else {
            dns_1.resolveSrv('_minecraft._tcp.' + hostname, (error, result) => {
                if (error) {
                    reject(error);
                }
                else {
                    if (result.length === 0 || !result[0]) {
                        reject(new Error('dns: no srv found with name'));
                    }
                    else {
                        resolve({
                            hostname: result[0].name,
                            port: result[0].port,
                        });
                    }
                }
            });
        }
    });
}
function openConnection(address) {
    let timeout;
    return new Promise((resolve, reject) => {
        const socket = net_1.createConnection(address.port, address.hostname, async () => {
            const packetDecoder = new PacketDecoder_1.PacketDecoder();
            socket.pipe(packetDecoder);
            packetDecoder.once('error', (error) => {
                socket.destroy();
                if (timeout) {
                    clearTimeout(timeout);
                }
                reject(error);
            });
            // handshake
            socket.write(createHandshakePacket(address));
            const handshakeData = await packetDecoder.oncePromise('handshake');
            // ping
            socket.write(createPingPacket(BigInt(Date.now())));
            const pingData = await packetDecoder.oncePromise('pong');
            if (timeout) {
                clearTimeout(timeout);
            }
            socket.end();
            resolve({
                ...handshakeData,
                ping: pingData,
            });
        });
        // Destroy on error
        socket.once('error', (error) => {
            socket.destroy();
            if (timeout) {
                clearTimeout(timeout);
            }
            reject(error);
        });
        // Destroy on timeout
        socket.once('timeout', () => {
            socket.destroy();
            if (timeout) {
                clearTimeout(timeout);
            }
            reject(new Error('Timed out'));
        });
        // Packet timeout (10 seconds)
        timeout = setTimeout(() => {
            socket.end();
            reject(new Error('Timed out (10 seconds passed)'));
        }, 10000);
    });
}
function createHandshakePacket(address) {
    const portBuffer = Buffer.allocUnsafe(2);
    portBuffer.writeUInt16BE(address.port, 0);
    // Return hansdhake packet with request packet
    return Buffer.concat([
        createPacket(0, Buffer.concat([
            Buffer.from(varint_1.encode(PROTOCOL_VERSION)),
            Buffer.from(varint_1.encode(address.hostname.length)),
            Buffer.from(address.hostname, 'utf8'),
            portBuffer,
            Buffer.from(varint_1.encode(1)),
        ])),
        createPacket(0, Buffer.alloc(0)),
    ]);
}
function createPingPacket(timestamp) {
    return createPacket(1, bigint_buffer_1.toBufferBE(timestamp, 8));
}
function createPacket(packetId, data) {
    return Buffer.concat([Buffer.from(varint_1.encode(varint_1.encodingLength(packetId) + data.length)), Buffer.from(varint_1.encode(packetId)), data]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsaURBQXlDO0FBQ3pDLDZCQUErQjtBQUMvQiw2QkFBMkM7QUFDM0MseUNBQTJCO0FBQzNCLG1DQUE4QztBQUU5QyxtREFBOEM7QUFFOUMsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsQ0FBQyxpQkFBaUI7QUFFL0M7Ozs7R0FJRztBQUNILFNBQWdCLE9BQU8sQ0FBQyxHQUFXO0lBQ2xDLE1BQU0sRUFBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEQsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFFBQVEsSUFBSSxRQUFRLEtBQUssWUFBWSxFQUFFO1FBQ3hELE1BQU0sSUFBSSxTQUFTLENBQUMsMkJBQTJCLENBQUMsQ0FBQztLQUNqRDtJQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlELENBQUM7QUFORCwwQkFNQztBQUVEOzs7OztHQUtHO0FBQ0ksS0FBSyxVQUFVLElBQUksQ0FBQyxXQUFtQixXQUFXLEVBQUUsT0FBZSxLQUFLO0lBQzlFLElBQUksT0FBTyxHQUFhLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDO0lBQ3pDLElBQUk7UUFDSCxPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ2pEO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDYixTQUFTO0tBQ1Q7SUFDRCxPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNoQyxDQUFDO0FBUkQsb0JBUUM7QUFFRCxTQUFT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QVksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNoQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxTQUFpQjtJQUMxQyxPQUFPLFlBQVksQ0FBQyxDQUFDLEVBQUUsMEJBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsRCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsUUFBZ0IsRUFBRSxJQUFZO0lBQ25ELE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBTSxDQUFDLHVCQUFjLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQzFILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3RvQnVmZmVyQkV9IGZyb20gJ2JpZ2ludC1idWZmZXInO1xyXG5pbXBvcnQge3Jlc29sdmVTcnZ9IGZyb20gJ2Rucyc7XHJcbmltcG9ydCB7Y3JlYXRlQ29ubmVjdGlvbiwgaXNJUH0gZnJvbSAnbmV0JztcclxuaW1wb3J0ICogYXMgdXJsIGZyb20gJ3VybCc7XHJcbmltcG9ydCB7ZW5jb2RlLCBlbmNvZGluZ0xlbmd0aH0gZnJvbSAndmFyaW50JztcclxuaW1wb3J0IHtJQWRkcmVzcywgSUhhbmRzaGFrZURhdGEsIElNaW5lY3JhZnREYXRhfSBmcm9tICcuL2ludGVyZmFjZXMnO1xyXG5pbXBvcnQge1BhY2tldERlY29kZXJ9IGZyb20gJy4vUGFja2V0RGVjb2Rlcic7XHJcblxyXG5jb25zdCBQUk9UT0NPTF9WRVJTSU9OID0gMzM1OyAvLyBNaW5lY3JhZnQgMS4xMlxyXG5cclxuLyoqXHJcbiAqIHBpbmcgd2l0aCBVUklcclxuICogQHBhcmFtIHtzdHJpbmd9IHVyaSBtaW5lY3JhZnQ6Ly9zZXJ2ZXJbOnBvcnRdXHJcbiAqIEByZXR1cm4ge1Byb21pc2U8SU1pbmVjcmFmdERhdGE+fVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHBpbmdVcmkodXJpOiBzdHJpbmcpIHtcclxuXHRjb25zdCB7cHJvdG9jb2wsIGhvc3RuYW1lLCBwb3J0fSA9IHVybC5wYXJzZSh1cmkpO1xyXG5cdGlmICghaG9zdG5hbWUgfHwgIXByb3RvY29sIHx8IHByb3RvY29sICE9PSAnbWluZWNyYWZ0OicpIHtcclxuXHRcdHRocm93IG5ldyBUeXBlRXJyb3IoJ25vdCBjb3JyZWN0IG1pbmVjcmFmdCBVUkknKTtcclxuXHR9XHJcblx0cmV0dXJuIHBpbmcoaG9zdG5hbWUsIHBvcnQgPyBwYXJzZUludChwb3J0LCAxMCkgOiB1bmRlZmluZWQpO1xyXG59XHJcblxyXG4vKipcclxuICogcGluZyB3aXRoIGhvc3RuYW1lIGFuZCBwb3J0XHJcbiAqIEBwYXJhbSB7c3RyaW5nPX0gaG9zdG5hbWUgaG9zdG5hbWVcclxuICogQHBhcmFtIHtudW1iZXI9fSBwb3J0IHBvcnQgbnVtYmVyIChkZWZhdWx0cyAyNTU2NSlcclxuICogQHJldHVybnMge1Byb21pc2U8SU1pbmVjcmFmdERhdGE+fVxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBpbmcoaG9zdG5hbWU6IHN0cmluZyA9ICdsb2NhbGhvc3QnLCBwb3J0OiBudW1iZXIgPSAyNTU2NSk6IFByb21pc2U8SU1pbmVjcmFmdERhdGE+IHtcclxuXHRsZXQgYWRkcmVzczogSUFkZHJlc3MgPSB7aG9zdG5hbWUsIHBvcnR9O1xyXG5cdHRyeSB7XHJcblx0XHRhZGRyZXNzID0gYXdhaXQgY2hlY2tTcnZSZWNvcmQoYWRkcmVzcy5ob3N0bmFtZSk7XHJcblx0fSBjYXRjaCAoZXJyKSB7XHJcblx0XHQvLyBpZ25vcmVcclxuXHR9XHJcblx0cmV0dXJuIG9wZW5Db25uZWN0aW9uKGFkZHJlc3MpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja1NydlJlY29yZChob3N0bmFtZTogc3RyaW5nKTogUHJvbWlzZTxJQWRkcmVzcz4ge1xyXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblx0XHRpZiAoaXNJUChob3N0bmFtZSkgIT09IDApIHtcclxuXHRcdFx0cmVqZWN0KG5ldyBFcnJvcignSG9zdG5hbWUgaXMgYW4gSVAgYWRkcmVzcycpKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHJlc29sdmVTcnYoJ19taW5lY3JhZnQuX3RjcC4nICsgaG9zdG5hbWUsIChlcnJvciwgcmVzdWx0KSA9PiB7XHJcblx0XHRcdFx0aWYgKGVycm9yKSB7XHJcblx0XHRcdFx0XHRyZWplY3QoZXJyb3IpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRpZiAocmVzdWx0Lmxlbmd0aCA9PT0gMCB8fCAhcmVzdWx0WzBdKSB7XHJcblx0XHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ2Ruczogbm8gc3J2IGZvdW5kIHdpdGggbmFtZScpKTtcclxuXHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdHJlc29sdmUoe1xyXG5cdFx0XHRcdFx0XHRcdGhvc3RuYW1lOiByZXN1bHRbMF0ubmFtZSxcclxuXHRcdFx0XHRcdFx0XHRwb3J0OiByZXN1bHRbMF0ucG9ydCxcclxuXHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHRcdH1cclxuXHR9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gb3BlbkNvbm5lY3Rpb24oYWRkcmVzczogSUFkZHJlc3MpOiBQcm9taXNlPElNaW5lY3JhZnREYXRhPiB7XHJcblx0bGV0IHRpbWVvdXQ6IFJldHVyblR5cGU8dHlwZW9mIHNldFRpbWVvdXQ+IHwgdW5kZWZpbmVkO1xyXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblx0XHRjb25zdCBzb2NrZXQgPSBjcmVhdGVDb25uZWN0aW9uKGFkZHJlc3MucG9ydCwgYWRkcmVzcy5ob3N0bmFtZSwgYXN5bmMgKCkgPT4ge1xyXG5cdFx0XHRjb25zdCBwYWNrZXREZWNvZGVyID0gbmV3IFBhY2tldERlY29kZXIoKTtcclxuXHRcdFx0c29ja2V0LnBpcGUocGFja2V0RGVjb2Rlcik7XHJcblx0XHRcdHBhY2tldERlY29kZXIub25jZSgnZXJyb3InLCAoZXJyb3IpID0+IHtcclxuXHRcdFx0XHRzb2NrZXQuZGVzdHJveSgpO1xyXG5cdFx0XHRcdGlmICh0aW1lb3V0KSB7XHJcblx0XHRcdFx0XHRjbGVhclRpbWVvdXQodGltZW91dCk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdHJlamVjdChlcnJvcik7XHJcblx0XHRcdH0pO1xyXG5cdFx0XHQvLyBoYW5kc2hha2VcclxuXHRcdFx0c29ja2V0LndyaXRlKGNyZWF0ZUhhbmRzaGFrZVBhY2tldChhZGRyZXNzKSk7XHJcblx0XHRcdGNvbnN0IGhhbmRzaGFrZURhdGEgPSBhd2FpdCBwYWNrZXREZWNvZGVyLm9uY2VQcm9taXNlPElIYW5kc2hha2VEYXRhPignaGFuZHNoYWtlJyk7XHJcblx0XHRcdC8vIHBpbmdcclxuXHRcdFx0c29ja2V0LndyaXRlKGNyZWF0ZVBpbmdQYWNrZXQoQmlnSW50KERhdGUubm93KCkpKSk7XHJcblx0XHRcdGNvbnN0IHBpbmdEYXRhID0gYXdhaXQgcGFja2V0RGVjb2Rlci5vbmNlUHJvbWlzZTxudW1iZXI+KCdwb25nJyk7XHJcblx0XHRcdGlmICh0aW1lb3V0KSB7XHJcblx0XHRcdFx0Y2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xyXG5cdFx0XHR9XHJcblx0XHRcdHNvY2tldC5lbmQoKTtcclxuXHJcblx0XHRcdHJlc29sdmUoe1xyXG5cdFx0XHRcdC4uLmhhbmRzaGFrZURhdGEsXHJcblx0XHRcdFx0cGluZzogcGluZ0RhdGEsXHJcblx0XHRcdH0pO1xyXG5cdFx0fSk7XHJcblx0XHQvLyBEZXN0cm95IG9uIGVycm9yXHJcblx0XHRzb2NrZXQub25jZSgnZXJyb3InLCAoZXJyb3IpID0+IHtcclxuXHRcdFx0c29ja2V0LmRlc3Ryb3koKTtcclxuXHRcdFx0aWYgKHRpbWVvdXQpIHtcclxuXHRcdFx0XHRjbGVhclRpbWVvdXQodGltZW91dCk7XHJcblx0XHRcdH1cclxuXHRcdFx0cmVqZWN0KGVycm9yKTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdC8vIERlc3Ryb3kgb24gdGltZW91dFxyXG5cdFx0c29ja2V0Lm9uY2UoJ3RpbWVvdXQnLCAoKSA9PiB7XHJcblx0XHRcdHNvY2tldC5kZXN0cm95KCk7XHJcblx0XHRcdGlmICh0aW1lb3V0KSB7XHJcblx0XHRcdFx0Y2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xyXG5cdFx0XHR9XHJcblx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ1RpbWVkIG91dCcpKTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdC8vIFBhY2tldCB0aW1lb3V0ICgxMCBzZWNvbmRzKVxyXG5cdFx0dGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG5cdFx0XHRzb2NrZXQuZW5kKCk7XHJcblx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ1RpbWVkIG91dCAoMTAgc2Vjb25kcyBwYXNzZWQpJykpO1xyXG5cdFx0fSwgMTAwMDApO1xyXG5cdH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVIYW5kc2hha2VQYWNrZXQoYWRkcmVzczogSUFkZHJlc3MpOiBCdWZmZXIge1xyXG5cdGNvbnN0IHBvcnRCdWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoMik7XHJcblx0cG9ydEJ1ZmZlci53cml0ZVVJbnQxNkJFKGFkZHJlc3MucG9ydCwgMCk7XHJcblx0Ly8gUmV0dXJuIGhhbnNkaGFrZSBwYWNrZXQgd2l0aCByZXF1ZXN0IHBhY2tldFxyXG5cdHJldHVybiBCdWZmZXIuY29uY2F0KFtcclxuXHRcdGNyZWF0ZVBhY2tldChcclxuXHRcdFx0MCxcclxuXHRcdFx0QnVmZmVyLmNvbmNhdChbXHJcblx0XHRcdFx0QnVmZmVyLmZyb20oZW5jb2RlKFBST1RPQ09MX1ZFUlNJT04pKSxcclxuXHRcdFx0XHRCdWZmZXIuZnJvbShlbmNvZGUoYWRkcmVzcy5ob3N0bmFtZS5sZW5ndGgpKSxcclxuXHRcdFx0XHRCdWZmZXIuZnJvbShhZGRyZXNzLmhvc3RuYW1lLCAndXRmOCcpLFxyXG5cdFx0XHRcdHBvcnRCdWZmZXIsXHJcblx0XHRcdFx0QnVmZmVyLmZyb20oZW5jb2RlKDEpKSxcclxuXHRcdFx0XSksXHJcblx0XHQpLFxyXG5cdFx0Y3JlYXRlUGFja2V0KDAsIEJ1ZmZlci5hbGxvYygwKSksXHJcblx0XSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVBpbmdQYWNrZXQodGltZXN0YW1wOiBiaWdpbnQpIHtcclxuXHRyZXR1cm4gY3JlYXRlUGFja2V0KDEsIHRvQnVmZmVyQkUodGltZXN0YW1wLCA4KSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVBhY2tldChwYWNrZXRJZDogbnVtYmVyLCBkYXRhOiBCdWZmZXIpOiBCdWZmZXIge1xyXG5cdHJldHVybiBCdWZmZXIuY29uY2F0KFtCdWZmZXIuZnJvbShlbmNvZGUoZW5jb2RpbmdMZW5ndGgocGFja2V0SWQpICsgZGF0YS5sZW5ndGgpKSwgQnVmZmVyLmZyb20oZW5jb2RlKHBhY2tldElkKSksIGRhdGFdKTtcclxufVxyXG4iXX0=